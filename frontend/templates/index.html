
{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            
            <!-- Scan Form Card -->
            <div class="card glass-card mb-4 animate-fade-in">
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-crosshairs fa-fw me-2 text-primary-glow"></i>
                    <h4 class="mb-0">Security Scan</h4>
                </div>
                <div class="card-body p-4">
                    <div id="scan-form">
                        <!-- Target URL Input -->
                        <div class="mb-4">
                            <label for="target-url" class="form-label text-white">
                                <i class="fas fa-globe fa-fw me-1"></i>Target URL
                            </label>
                            <input type="url" class="form-control form-control-lg" id="target-url" 
                                   placeholder="https://example.com" required>
                            <div class="form-text text-white-50">Enter the target website URL to scan for vulnerabilities</div>
                        </div>

                        <!-- Scan Mode Selection -->
                        <div class="mb-4">
                            <label class="form-label text-white mb-3">
                                <i class="fas fa-cogs fa-fw me-1"></i>Scan Mode
                            </label>
                            <div class="scan-mode-chips">
                                <div class="scan-mode-chip" data-mode="ultra-safe" data-tooltip="Minimal scanning for large public sites (Google, Facebook, etc.) - skips headers and XSS">
                                    <i class="fa-regular fa-shield-check"></i>
                                    <span>Ultra-Safe</span>
                                </div>
                                <div class="scan-mode-chip" data-mode="safe" data-tooltip="Fast scanning with reduced checks and shallow crawling">
                                    <i class="fas fa-shield-alt fa-fw"></i>
                                    <span>Safe</span>
                                </div>
                                <div class="scan-mode-chip active" data-mode="standard" data-tooltip="Balanced coverage with standard vulnerability checks">
                                    <i class="fas fa-balance-scale fa-fw"></i>
                                    <span>Standard</span>
                                </div>
                                <div class="scan-mode-chip" data-mode="aggressive" data-tooltip="Thorough scanning with all checks including open redirects and parameter fuzzing">
                                    <i class="fas fa-fire fa-fw"></i>
                                    <span>Aggressive</span>
                                </div>
                            </div>
                            <input type="hidden" id="scan-mode" value="standard">
                        </div>

                        <!-- Authentication Section -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-shield-alt fa-fw me-2 text-primary"></i>
                                <h6 class="mb-0 text-white">Authentication (Optional)</h6>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="auth-type" class="form-label text-white-50">Auth Type</label>
                                    <select class="form-select" id="auth-type">
                                        <option value="">None</option>
                                        <option value="form">Form-based</option>
                                        <option value="token">Token-based</option>
                                        <option value="basic">HTTP Basic</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="username" class="form-label text-white-50">Username</label>
                                    <input type="text" class="form-control" id="username" placeholder="admin">
                                </div>
                                <div class="col-md-4">
                                    <label for="password" class="form-label text-white-50">Password</label>
                                    <input type="password" class="form-control" id="password" placeholder="password">
                                </div>
                            </div>
                            
                            <!-- Additional auth fields -->
                            <div id="auth-extra-fields" class="mt-3" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="login-url" class="form-label text-white-50">Login URL</label>
                                        <input type="text" class="form-control" id="login-url" placeholder="/login">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="token" class="form-label text-white-50">Token</label>
                                        <input type="text" class="form-control" id="token" placeholder="Bearer token">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Options Section -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-code fa-fw me-2 text-info"></i>
                                <h6 class="mb-0 text-white">Advanced Options</h6>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable-js" value="true">
                                <label class="form-check-label text-white-50" for="enable-js">
                                    <strong>Enable JavaScript Rendering</strong> (slower, finds more vulnerabilities on JS-heavy sites)
                                    <br><small class="text-muted">Uses Playwright to crawl JavaScript-rendered content. Required for React, Vue, Angular apps.</small>
                                </label>
                            </div>
                        </div>

                        <!-- Start Scan Button -->
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" id="start-scan">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                                <span class="btn-text"><i class="fas fa-search fa-fw"></i> Start Scan</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress-container" class="mb-4" style="display: none;">
                <div class="card glass-card">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Scan in Progress...</h5>
                        <p id="current-task" class="text-white-50 mb-2">Initializing...</p>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary-gradient" role="progressbar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="error-container" class="alert alert-danger" style="display: none;">
                <strong><i class="fas fa-exclamation-triangle fa-fw"></i> Error:</strong> <span id="error-message"></span>
            </div>

            <!-- Results Section -->
            <div id="results-container" class="mt-4" style="display: none;">
                <div class="animate-fade-in-slow">
                    <h2 class="mb-4 text-white">Scan Report: <code class="text-primary-glow" id="report-target-url"></code></h2>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100" title="Total number of unique vulnerabilities found">
                                <div class="card-body"><h3 id="total-vulns" class="text-primary-glow">0</h3><p class="mb-0"><i class="fas fa-bug fa-fw"></i> Total Findings</p></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100" title="Severity: High (CVSS 7.0-8.9) - Immediate attention needed">
                                <div class="card-body"><h3 id="high-vulns" class="severity-high">0</h3><p class="mb-0"><i class="fas fa-exclamation-triangle fa-fw"></i> High Severity</p></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100" title="Severity: Medium (CVSS 4.0-6.9) - Should be addressed soon">
                                <div class="card-body"><h3 id="medium-vulns" class="severity-medium">0</h3><p class="mb-0"><i class="fas fa-exclamation-circle fa-fw"></i> Medium Severity</p></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100" title="Severity: Low (CVSS 0.1-3.9) - Can be addressed as resources allow">
                                <div class="card-body"><h3 id="low-vulns" class="severity-low">0</h3><p class="mb-0"><i class="fas fa-info-circle fa-fw"></i> Low Severity</p></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Metrics Cards -->
                    <div class="row mb-4" id="enhanced-metrics" style="display: none;">
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100 bg-gradient-danger" title="Average CVSS score across all findings. Higher score = more critical">
                                <div class="card-body"><h3 id="avg-cvss" class="text-white">0.0</h3><p class="mb-0 text-white-50"><i class="fas fa-chart-bar fa-fw"></i> Avg CVSS Score</p></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100 bg-gradient-warning" title="Findings with Critical priority (highest remediation urgency)">
                                <div class="card-body"><h3 id="critical-priority" class="text-white">0</h3><p class="mb-0 text-white-50"><i class="fas fa-flag fa-fw"></i> Critical Priority</p></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100 bg-gradient-info" title="Findings with published exploits (actively exploited in the wild)">
                                <div class="card-body"><h3 id="with-exploit" class="text-white">0</h3><p class="mb-0 text-white-50"><i class="fas fa-bug fa-fw"></i> With Exploits</p></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card summary-card h-100 bg-gradient-success" title="Findings with 80%+ confidence (highly reliable detections)">
                                <div class="card-body"><h3 id="high-confidence" class="text-white">0</h3><p class="mb-0 text-white-50"><i class="fas fa-check-double fa-fw"></i> High Confidence</p></div>
                            </div>
                        </div>
                    </div>

                    <!-- Details Card -->
                    <div class="card glass-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-bug fa-fw me-2 text-primary-glow"></i>Vulnerability Details</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-success" id="download-json"><i class="fas fa-file-code fa-fw"></i> JSON</button>
                                <button type="button" class="btn btn-sm btn-outline-light" id="download-md"><i class="fab fa-markdown fa-fw"></i> Markdown</button>
                            </div>
                        </div>
                        <div class="card-body p-0" style="min-height: 500px;">
                            <div class="vulnerability-container">
                                <div class="vulnerability-list-panel" id="list-panel">
                                    <div id="vulnerability-accordion">
                                <!-- Vulnerabilities will be dynamically injected here -->
                                    </div>
                                </div>
                                <div class="vulnerability-detail-panel" id="detail-panel">
                                    <div class="detail-header-controls" style="padding: 10px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
                                        <button class="btn btn-sm btn-outline-primary" id="prev-vuln" onclick="navigateVuln(-1)" style="display: none;" title="Previous">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" id="expand-minimize-btn" onclick="toggleExpandMinimize()" title="Expand">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" id="next-vuln" onclick="navigateVuln(1)" style="display: none;" title="Next">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="detail-content" id="detail-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let statusInterval;

    const vulnerabilityDB = {
        'SQL Injection': {
            title: 'SQL Injection (SQLi)',
            what: `SQL Injection is a code injection technique that might destroy your database. It's one of a web application's most common and dangerous security vulnerabilities.`,
            how: `An attacker can get access to your database by inserting their own SQL commands into your application's queries. This usually happens through form inputs (like a search bar or login form) when the application doesn't properly sanitize the user's input. Attackers can then steal, modify, or delete data, and in some cases, gain full control of the server.`,
            prevention: `<ul><li><strong>Use Prepared Statements (with Parameterized Queries):</strong> This is the most effective defense. It separates the SQL query's logic from its data, making it impossible for an attacker's input to be executed as code.</li><li><strong>Validate and Sanitize All User Input:</strong> Treat all input from users as untrusted. Implement strict validation rules for data types, formats, and lengths on the server side.</li><li><strong>Enforce Least Privilege:</strong> The database account used by your application should only have the absolute minimum permissions it needs to function.</li></ul>`
        },
        'Cross-Site Scripting (XSS)': {
            title: 'Cross-Site Scripting (XSS)',
            what: `Cross-Site Scripting is a vulnerability that allows an attacker to inject malicious scripts (usually JavaScript) into web pages viewed by other users.`,
            how: `The attacker injects a malicious script into user-generated content, like a comment section. When another user visits that page, their browser executes the script, believing it's a trusted part of the website.`,
            prevention: `<ul><li><strong>Context-Aware Output Encoding:</strong> Before rendering user-provided content in HTML, encode it so the browser treats it as plain text, not executable code.</li><li><strong>Implement a Content Security Policy (CSP):</strong> A CSP is a security header that tells the browser which sources of content are allowed.</li><li><strong>Set the HttpOnly Flag on Cookies:</strong> This prevents client-side scripts from accessing sensitive session cookies.</li></ul>`
        },
        'Reflected XSS': {
            title: 'Reflected Cross-Site Scripting (XSS)',
            what: `Reflected XSS happens when malicious input from a URL parameter is immediately included in the page output without sanitization.`,
            how: `An attacker tricks a user into clicking a malicious link that reflects a script back into their browser, stealing data or hijacking sessions.`,
            prevention: `<ul><li><strong>Context-Aware Output Encoding:</strong> Encode user input before rendering in HTML.</li><li><strong>Input Validation:</strong> Reject suspicious or malformed data.</li><li><strong>Content Security Policy (CSP):</strong> Restrict script execution to trusted sources.</li></ul>`
        },
        'Missing X-Frame-Options': {
            title: 'Missing X-Frame-Options Header',
            what: `The X-Frame-Options header prevents clickjacking attacks.`,
            how: `Without it, attackers can load your site inside an invisible iframe and trick users into clicking on hidden buttons.`,
            prevention: `<ul><li><code>X-Frame-Options: DENY</code></li><li><code>X-Frame-Options: SAMEORIGIN</code></li></ul>`
        },
        'Possible SQL Injection': {
        title: 'Possible SQL Injection (SQLi)',
        what: "SQL Injection is a code injection technique that might destroy your database. It's one of a web application's most common and dangerous security vulnerabilities.",
        how: "An attacker can get access to your database by inserting their own SQL commands into your application's queries. This usually happens through form inputs (like a search bar or login form) when the application doesn't properly sanitize the user's input. Attackers can then steal, modify, or delete data, and in some cases, gain full control of the server.",
        prevention: "<ul><li><strong>Use Prepared Statements (with Parameterized Queries):</strong> This is the most effective defense. It separates the SQL query's logic from its data, making it impossible for an attacker's input to be executed as code.</li><li><strong>Validate and Sanitize All User Input:</strong> Treat all input from users as untrusted. Implement strict validation rules for data types, formats, and lengths on the server side.</li><li><strong>Enforce Least Privilege:</strong> The database account used by your application should only have the absolute minimum permissions it needs to function.</li></ul>"
        },
        'Missing Content-Security-Policy': {
        title: 'Missing Content-Security-Policy (CSP) Header',
        what: "Content Security Policy (CSP) is a powerful security layer that helps detect and mitigate certain types of attacks, including Cross-Site Scripting (XSS) and data injection attacks.",
        how: "Without a CSP, if an attacker finds an XSS vulnerability, their malicious script can make requests to any domain on the internet to load more scripts or send stolen data (like session cookies). A CSP acts as a whitelist for your website's content.",
        prevention: "<strong>Implement a `Content-Security-Policy` HTTP header.</strong> A basic policy might be `Content-Security-Policy: default-src 'self'`. This tells the browser to only load content (scripts, images, styles) from your own domain. Creating a CSP requires careful planning to ensure you don't block legitimate resources."
    },
    'Missing Strict-Transport-Security': {
        title: 'Missing HTTP Strict-Transport-Security (HSTS) Header',
        what: "HTTP Strict Transport Security (HSTS) is a security header that forces a user's browser to only connect to your website using secure HTTPS connections, never insecure HTTP.",
        how: "Without HSTS, a user might first connect to your site via HTTP. An attacker on the same network (e.g., public Wi-Fi) can intercept this initial request and perform a man-in-the-middle attack, redirecting the user to a fake site or capturing data before the server can redirect to HTTPS. HSTS tells the browser to *never* make that initial insecure connection.",
        prevention: "<strong>Add the `Strict-Transport-Security` header to your HTTPS responses.</strong> A recommended value is `Strict-Transport-Security: max-age=31536000; includeSubDomains`. This instructs the browser to enforce HTTPS for one year for both the main domain and all its subdomains."
    },
    'HTTPS not enforced': {
        title: 'HTTPS Not Enforced',
        what: "This vulnerability means the website is accessible over unencrypted HTTP, or it does not automatically redirect all HTTP traffic to a secure HTTPS connection.",
        how: "Any data sent over HTTP is in plain text. An attacker on the same network can easily intercept, read, or modify the traffic between the user and the server. This includes sensitive information like login credentials, session cookies, and personal data.",
        prevention: "<ul><li><strong>Configure your web server (e.g., Nginx, Apache) to issue a permanent (301) redirect for all HTTP requests to their HTTPS equivalent.</strong></li><li><strong>Ensure all internal resources (images, scripts, links) use HTTPS URLs.</strong></li><li><strong>Enable the `Secure` flag on all session cookies.</strong></li></ul>"
    },
    'Open Redirect': {
        title: 'Open Redirect',
        what: "An Open Redirect is a vulnerability where an application uses a user-supplied parameter to redirect the user to another URL without proper validation.",
        how: "An attacker can craft a link to your trusted website that contains a redirect parameter pointing to a malicious site. For example: `https://your-trusted-site.com/redirect?url=https://malicious-phishing-site.com`. A user sees the trusted domain, clicks the link, and is then unknowingly redirected to the attacker's phishing page.",
        prevention: "<strong>Avoid using redirects that rely on user-supplied destinations.</strong> If you must, maintain a server-side whitelist of approved and safe URLs. Reject any redirect request that does not match an entry in the whitelist."
    },
    'Command Injection': {
        title: 'Command Injection (OS Injection)',
        what: "Command Injection is an attack technique used for unauthorized execution of operating system commands. This attack is possible when an application passes unsafe user supplied data to a system shell.",
        how: "An attacker injects malicious commands (like `; cat /etc/passwd` or `| whoami`) into user input fields. If the application passes this input directly to the system shell without proper sanitization, the commands are executed on the server, giving the attacker control over the system.",
        prevention: "<ul><li><strong>Avoid shell execution altogether:</strong> Use safe APIs that don't invoke the shell.</li><li><strong>If shell execution is unavoidable:</strong> Validate and whitelist allowed commands and arguments, never trust user input.</li><li><strong>Use parameterized commands:</strong> Pass arguments as arrays, not as command strings.</li><li><strong>Run with least privilege:</strong> Execute commands with minimal required permissions.</li></ul>"
    },
    'Weak Login Page Security': {
        title: 'Weak Login Page Security',
        what: "Login pages that lack essential security features like rate limiting, CAPTCHA protection, strong password requirements, and account lockout mechanisms are vulnerable to brute force attacks.",
        how: "Attackers can repeatedly attempt to guess passwords without rate limiting, use automated tools for brute force attacks, and easily bypass weak login protections to gain unauthorized access to accounts.",
        prevention: "<ul><li><strong>Implement Rate Limiting:</strong> Limit login attempts per IP or account.</li><li><strong>Add CAPTCHA:</strong> Prevent automated attacks after a few failed attempts.</li><li><strong>Strong Password Policy:</strong> Require complex passwords with minimum length, mixed case, numbers, and special characters.</li><li><strong>Account Lockout:</strong> Temporarily lock accounts after repeated failed login attempts.</li><li><strong>CSRF Protection:</strong> Include CSRF tokens in login forms.</li></ul>"
    },
    'Broken Access Control': {
        title: 'Broken Access Control',
        what: "Broken Access Control occurs when an application fails to properly enforce authorization restrictions, allowing unauthorized users to access privileged resources or perform restricted actions.",
        how: "Attackers can directly access admin panels, view other users' data, modify accounts without permission, or access internal APIs that should require authentication.",
        prevention: "<ul><li><strong>Enforce Authorization on Every Request:</strong> Don't rely on clients hiding URLs.</li><li><strong>Verify Permissions on All Privileged Actions:</strong> Check user permissions on the server side for every action.</li><li><strong>Implement Role-Based Access Control (RBAC):</strong> Define clear roles and enforce access accordingly.</li><li><strong>Use Authentication Tokens:</strong> Properly implement and validate JWT or session tokens.</li></ul>"
    },
    'Server-Side Request Forgery (SSRF)': {
        title: 'Server-Side Request Forgery (SSRF)',
        what: "SSRF attacks allow an attacker to induce the server-side application to make HTTP requests to an任意 URL of the attacker's choosing.",
        how: "An attacker exploits a vulnerable parameter (like `url=`, `fetch=`, or `api=`) to make the server request internal services (like 127.0.0.1, localhost) or external malicious sites. This can lead to data exfiltration, internal network probing, or cloud metadata service access.",
        prevention: "<ul><li><strong>Whitelist Allowed URLs:</strong> Maintain a strict whitelist of permitted destinations.</li><li><strong>Block Internal IPs:</strong> Reject requests to private IP ranges (127.0.0.1, 10.0.0.0/8, 192.168.0.0/16).</li><li><strong>Validate URL Schemes:</strong> Only allow http:// and https:// protocols.</li><li><strong>Use Network Segmentation:</strong> Limit the network access of application servers.</li></ul>"
    },
    'Insecure File Upload': {
        title: 'Insecure File Upload Vulnerability',
        what: "Applications that allow file uploads without proper validation can be exploited to upload malicious files (executables, webshells) or perform directory traversal attacks.",
        how: "Attackers upload malicious files (PHP shells, executables, .htaccess files) or manipulate filenames to access restricted directories or execute code on the server.",
        prevention: "<ul><li><strong>Whitelist File Types:</strong> Only allow specific, safe file extensions and validate MIME types.</li><li><strong>Validate File Content:</strong> Check file magic bytes, not just extension or content-type header.</li><li><strong>Sanitize Filenames:</strong> Remove special characters and directory traversal sequences.</li><li><strong>Store Files Securely:</strong> Upload to directory outside web root or use random filenames.</li><li><strong>Set Size Limits:</strong> Enforce maximum file size to prevent DoS attacks.</li></ul>"
    },
    'XML External Entity (XXE) Injection': {
        title: 'XML External Entity (XXE) Injection',
        what: "XXE vulnerabilities occur when an application processes XML input containing external entity references, allowing attackers to read local files or perform SSRF attacks.",
        how: "Attacker crafts XML payloads with external entity declarations that reference local files (like /etc/passwd) or external URLs. The XML parser processes these entities and includes sensitive data in the response.",
        prevention: "<ul><li><strong>Disable External Entity Processing:</strong> Configure XML parser to ignore DOCTYPE declarations and external entities.</li><li><strong>Use Safe XML Parsers:</strong> Use libraries that disable external entity processing by default.</li><li><strong>Whitelist XML Input:</strong> Validate XML against schema before processing.</li><li><strong>Minimize XML Parsing:</strong> Prefer JSON or other formats over XML.</li></ul>"
    },
    'XML Injection': {
        title: 'XML Injection',
        what: "XML Injection occurs when an application accepts and processes XML input without proper validation, potentially leading to XXE, XML bombs, or data manipulation.",
        how: "Attacker injects malicious XML content to exploit parser vulnerabilities, bypass authorization checks, or manipulate application logic.",
        prevention: "<ul><li><strong>Validate XML Input:</strong> Use XML schema (XSD) validation before processing.</li><li><strong>Sanitize User Input:</strong> Encode special XML characters (&lt;, &gt;, &amp;, etc.).</li><li><strong>Limit Parser Features:</strong> Disable dangerous XML features like external entities, CDATA, etc.</li><li><strong>Use Prepared Statements:</strong> Parameterize XML queries.</li></ul>"
    },
    'HTML Injection': {
        title: 'HTML Injection',
        what: "HTML Injection occurs when user input is reflected in HTML responses without proper encoding, allowing attackers to inject arbitrary HTML elements.",
        how: "Attacker submits HTML tags in input fields. If reflected unencoded, these tags are rendered in the browser, potentially leading to XSS or content spoofing attacks.",
        prevention: "<ul><li><strong>Output Encoding:</strong> Encode all user input before rendering in HTML context (use HTML entity encoding).</li><li><strong>Content Security Policy:</strong> Implement CSP to restrict script execution.</li><li><strong>Input Validation:</strong> Reject or sanitize HTML tags in user input.</li><li><strong>Use Framework Escaping:</strong> Leverage framework's built-in HTML escaping functions.</li></ul>"
    },
    'Insecure File Upload: PHP Script': {
        title: 'Insecure File Upload: PHP Script',
        what: "Application accepts PHP files for upload, allowing attackers to execute code on the server.",
        how: "Attacker uploads a PHP shell script that can execute arbitrary commands on the server, leading to remote code execution and full system compromise.",
        prevention: "Whitelist safe file types only, validate file content using magic bytes, store uploads outside web root with random names."
    },
    'Insecure File Upload: Server Script': {
        title: 'Insecure File Upload: Server Script',
        what: "Application accepts server-side scripts (ASP, JSP) that can execute code on the server.",
        how: "Uploaded server scripts can execute arbitrary commands, access the filesystem, and compromise the application.",
        prevention: "Prevent uploads of executable scripts. Whitelist only safe file types and validate content."
    },
    'Insecure File Upload: Executable': {
        title: 'Insecure File Upload: Executable File',
        what: "Application accepts executable files (.exe, .sh, .bat) that could contain malware.",
        how: "Uploaded executables can contain malware, backdoors, or system exploits that compromise server security.",
        prevention: "Block all executable file types. Scan uploaded files with antivirus and validate thoroughly."
    },
    'Insecure File Upload: Apache Configuration': {
        title: 'Insecure File Upload: Apache Configuration',
        what: "Application accepts .htaccess files that can modify Apache configuration.",
        how: ".htaccess files can override server settings, enable PHP execution, or redirect traffic to malicious sites.",
        prevention: "Block .htaccess uploads and other configuration files. Use server-level configuration."
    },
    'Insecure File Upload: HTML/JavaScript': {
        title: 'Insecure File Upload: HTML/JavaScript',
        what: "Application accepts HTML files that can contain malicious JavaScript.",
        how: "Uploaded HTML files can execute XSS attacks when accessed, stealing cookies or session tokens.",
        prevention: "Validate and sanitize HTML content. Use Content Security Policy to prevent XSS."
    },
    'Path Traversal in File Upload': {
        title: 'Path Traversal in File Upload',
        what: "File upload allows path traversal sequences (../../) in filenames, enabling uploads to arbitrary directories.",
        how: "Attacker crafts filenames like '../../malicious.php' to upload files outside intended directories, potentially accessing sensitive areas.",
        prevention: "Strip directory traversal sequences from filenames. Use absolute paths and random generated filenames."
    },
    'Missing File Size Limits': {
        title: 'Missing File Size Limits',
        what: "Application doesn't enforce file size limits on uploads, allowing potential DoS attacks.",
        how: "Large file uploads can consume server resources, disk space, and bandwidth, leading to denial of service.",
        prevention: "Implement strict file size limits on both client and server side. Monitor upload sizes."
    },
    'Content-Type Validation Bypass': {
        title: 'Content-Type Validation Bypass',
        what: "Application validates files based on Content-Type header only, which can be spoofed.",
        how: "Attacker changes Content-Type header to 'image/jpeg' while uploading a PHP shell, bypassing validation.",
        prevention: "Validate actual file content using magic bytes (file signature), not just headers or extensions."
    },
    'Directory Traversal in Uploaded Filename': {
        title: 'Directory Traversal in Uploaded Filename',
        what: "Uploaded files can be placed in arbitrary directories through path traversal in filenames.",
        how: "Filenames containing ../../../ allow placing files in parent directories, potentially accessing web root or sensitive locations.",
        prevention: "Sanitize filenames, strip traversal sequences, use absolute storage paths with random names."
    },
    'Command Injection (Unix)': {
        title: 'Command Injection (Unix/Linux)',
        what: "Application executes Unix shell commands with user input, allowing arbitrary command execution.",
        how: "Attacker injects Unix commands like '; cat /etc/passwd' or '| whoami' to read files or execute system commands.",
        prevention: "Avoid shell execution. Use parameterized APIs. If necessary, whitelist allowed commands and validate inputs."
    },
    'Command Injection (Windows)': {
        title: 'Command Injection (Windows)',
        what: "Application executes Windows CMD commands with user input, allowing arbitrary command execution.",
        how: "Attacker injects Windows commands like '& dir' or '| type C:\\Windows\\System32\\hosts' to execute system commands.",
        prevention: "Avoid shell execution. Use .NET APIs instead of Process.Start with shell. Validate all inputs."
    },
    'Command Injection (Time-based Blind)': {
        title: 'Command Injection (Time-based Blind)',
        what: "Application executes commands based on user input but doesn't return output (blind execution).",
        how: "Attacker uses time delays ('sleep 5') to confirm command injection even when output isn't visible.",
        prevention: "Never execute user input as commands. Use safe APIs and parameterized functions."
    },
    'Session ID in URL': {
        title: 'Session ID in URL',
        what: "Session identifier is exposed in URL parameters instead of being stored in secure cookies.",
        how: "Session IDs in URLs are logged in server logs, browser history, and shared URLs, exposing session tokens to attackers.",
        prevention: "Store session IDs in HttpOnly, Secure cookies. Never include session tokens in URLs or logs."
    },
    'Insecure Cookie (Missing Secure Flag)': {
        title: 'Insecure Cookie - Missing Secure Flag',
        what: "Session cookies lack the Secure flag, allowing transmission over unencrypted HTTP connections.",
        how: "On HTTP sites, session cookies can be intercepted by attackers on the same network, allowing session hijacking.",
        prevention: "Always set Secure flag on session cookies when using HTTPS. Force HTTPS for all authentication."
    },
    'Cookie Missing HttpOnly Flag': {
        title: 'Cookie Missing HttpOnly Flag',
        what: "Session cookies lack the HttpOnly flag, making them accessible to JavaScript.",
        how: "If XSS is found, attacker can steal cookies via document.cookie, leading to session hijacking.",
        prevention: "Set HttpOnly flag on all session cookies to prevent JavaScript access."
    }
        // ✅ Add other entries similarly (always use backticks for multiline text)
    };

    // Handle scan mode chip selection
    $('.scan-mode-chip').click(function() {
        $('.scan-mode-chip').removeClass('active');
        $(this).addClass('active');
        $('#scan-mode').val($(this).data('mode'));
    });

    // Handle authentication type changes
    $('#auth-type').change(function() {
        const authType = $(this).val();
        if (authType === 'form') {
            $('#auth-extra-fields').show();
            $('#login-url').closest('.col-md-6').show();
            $('#token').closest('.col-md-6').hide();
            $('#username, #password').closest('.col-md-4').show();
        } else if (authType === 'token') {
            $('#auth-extra-fields').show();
            $('#login-url').closest('.col-md-6').hide();
            $('#token').closest('.col-md-6').show();
            $('#username, #password').closest('.col-md-4').hide();
        } else if (authType === 'basic') {
            $('#auth-extra-fields').hide();
            $('#username, #password').closest('.col-md-4').show();
        } else {
            $('#auth-extra-fields').hide();
            $('#username, #password').closest('.col-md-4').hide();
        }
    });

    $('#start-scan').click(function() {
        const url = $('#target-url').val();
        if (!url) {
            alert('Please enter a target URL.');
            return;
        }
        startScan(url);
    });
    
    function startScan(url) {
        $('#results-container').hide();
        $('#error-container').hide();
        $('#progress-container').show();
        $('#start-scan .spinner-border').show();
        $('#start-scan .btn-text').text('Scanning...');
        $('#start-scan').prop('disabled', true);
        
        // Collect scan configuration
        const jsEnabled = $('#enable-js').is(':checked');
        console.log('[DEBUG] Checkbox checked:', jsEnabled);
        
        const scanConfig = {
            url: url,
            mode: $('#scan-mode').val(),
            auth_type: $('#auth-type').val(),
            username: $('#username').val(),
            password: $('#password').val(),
            login_url: $('#login-url').val(),
            token: $('#token').val(),
            js_enabled: jsEnabled
        };
        
        console.log('[DEBUG] Sending scan config:', scanConfig);
        
        $.ajax({
            url: '/api/scan',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(scanConfig),
            success: function(response) {
                statusInterval = setInterval(checkStatus, 1500);
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to start scan';
                showError(error);
                resetUI();
            }
        });
    }
    
    function checkStatus() {
        $.ajax({
            url: '/api/status',
            method: 'GET',
            success: function(status) {
                updateProgress(status);
                
                if (!status.running) {
                    clearInterval(statusInterval);
                    if (status.error) {
                        showError(status.error);
                    } else if (status.results) {
                        showResults(status.results);
                    }
                    resetUI();
                }
            },
            error: function() {
                clearInterval(statusInterval);
                showError('Lost connection to the server.');
                resetUI();
            }
        });
    }
    
    function updateProgress(status) {
        const progress = status.progress || 0;
        $('#progress-bar').css('width', progress + '%').text(progress + '%');
        $('#current-task').text(status.current_task || 'Processing...');
    }
    
    function showResults(results) {
        $('#progress-container').hide();
        $('#results-container').show();
        
        $('#report-target-url').text(results.target_url);
        $('#total-vulns').text(results.total_vulnerabilities);
        $('#high-vulns').text(results.vulnerabilities_by_severity.High || 0);
        $('#medium-vulns').text(results.vulnerabilities_by_severity.Medium || 0);
        $('#low-vulns').text(results.vulnerabilities_by_severity.Low || 0);
        
        // Calculate enhanced metrics
        const findings = results.findings || [];
        let totalCvss = 0;
        let cvssCount = 0;
        let criticalPriority = 0;
        let withExploit = 0;
        let highConfidence = 0;
        
        findings.forEach(finding => {
            if (finding.cvss_base_score) {
                totalCvss += finding.cvss_base_score;
                cvssCount++;
            }
            if (finding.final_priority === 'Critical') {
                criticalPriority++;
            }
            if (finding.exploit_published) {
                withExploit++;
            }
            if (finding.confidence && typeof finding.confidence === 'number' && finding.confidence >= 0.8) {
                highConfidence++;
            }
        });
        
        const avgCvss = cvssCount > 0 ? (totalCvss / cvssCount).toFixed(1) : '0.0';
        
        $('#avg-cvss').text(avgCvss);
        $('#critical-priority').text(criticalPriority);
        $('#with-exploit').text(withExploit);
        $('#high-confidence').text(highConfidence);
        
        // Show enhanced metrics if any CVSS data exists
        if (cvssCount > 0) {
            $('#enhanced-metrics').show();
        }
        
        $('#download-json').off('click').on('click', () => downloadReport(results.json_report));
        $('#download-md').off('click').on('click', () => downloadReport(results.md_report));
        
        displayVulnerabilityGroups(findings);
    }
    
    function displayVulnerabilityGroups(findings) {
        const container = $('#vulnerability-accordion');
        container.empty();
        
        if (findings.length === 0) {
            container.html('<div class="text-center p-5"><i class="fas fa-check-circle fa-4x text-success mb-4" style="animation: fadeIn 1s ease-in-out;"></i><h4 class="mt-3 text-success">Congratulations!</h4><p class="text-white-50 mb-0">No vulnerabilities were found during this scan. The target appears to be secure.</p></div>');
            return;
        }

        const groupedFindings = findings.reduce((acc, finding) => {
            const key = finding.vulnerability;
            if (!acc[key]) {
                acc[key] = [];
            }
            acc[key].push(finding);
            return acc;
        }, {});

        Object.entries(groupedFindings).forEach(([groupName, groupItems], index) => {
            const firstItem = groupItems[0];
            const severityClass = firstItem.severity.toLowerCase();
            const vulnerabilityInfo = vulnerabilityDB[groupName] || { title: groupName, what: 'No description available.', how: '', prevention: '' };

            // Create list item
            const listItem = $(`
                <div class="vuln-list-item" data-group-name="${groupName}" data-index="${index}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-${severityClass} me-2" title="Severity Level">${firstItem.severity}</span>
                                <h6 class="mb-0" style="color: #e0e0e0;">${groupName}</h6>
                                <span class="badge rounded-pill bg-secondary ms-2" title="Number of occurrences">${groupItems.length}</span>
                            </div>
                            ${firstItem.payload ? `<div class="text-white-50 mb-1" style="font-size: 0.8rem;"><i class="fas fa-crosshairs fa-fw"></i> Payload: <code>${firstItem.payload.substring(0, 40)}${firstItem.payload.length > 40 ? '...' : ''}</code></div>` : ''}
                            <div class="text-white-50" style="font-size: 0.85rem;">
                                <i class="fas fa-link fa-fw"></i> ${firstItem.url.substring(0, 60)}${firstItem.url.length > 60 ? '...' : ''}
                            </div>
                        </div>
                        <div class="ms-3 text-center">
                            ${firstItem.cvss_base_score ? `<div class="mb-1"><span class="badge bg-danger" title="Common Vulnerability Scoring System base score (0.0-10.0)">CVSS ${firstItem.cvss_base_score.toFixed(1)}</span></div>` : ''}
                            ${firstItem.final_priority ? `<div class="mb-1"><span class="badge bg-${firstItem.final_priority === 'Critical' ? 'danger' : firstItem.final_priority === 'High' ? 'warning' : firstItem.final_priority === 'Medium' ? 'info' : 'secondary'}" title="Final computed priority considering CVSS, assets, and exploits">${firstItem.final_priority}</span></div>` : ''}
                            ${typeof firstItem.confidence === 'number' ? `<div class="mb-1"><span class="badge bg-info" title="Detection confidence (0-100%)">${(firstItem.confidence * 100).toFixed(0)}%</span></div>` : ''}
                            <i class="fas fa-chevron-right text-primary"></i>
                        </div>
                    </div>
                </div>
            `);
            
            // Attach click handler
            listItem.on('click', function() {
                const groupName = $(this).data('group-name');
                const index = $(this).data('index');
                showVulnerabilityDetail(groupName, index, groupedFindings[groupName]);
            });
            
            container.append(listItem);
        });

        // Store the grouped findings globally for access in detail panel
        window.groupedFindings = groupedFindings;
    }

    // Store current vulnerability index for navigation
    let currentVulnIndex = 0;
    let allVulnGroups = [];

    function showVulnerabilityDetail(groupName, index, groupItems) {
        const vulnerabilityInfo = vulnerabilityDB[groupName] || { title: groupName, what: 'No description available.', how: '', prevention: '' };
        
        // Store current index
        currentVulnIndex = parseInt(index);
        allVulnGroups = Object.keys(window.groupedFindings);
        
        // Remove active class from all items
        $('.vuln-list-item').removeClass('active');
        // Add active class to clicked item
        $(`.vuln-list-item[data-index="${index}"]`).addClass('active');

        // Check if we're in full mode
        const isFullMode = $('#detail-panel').hasClass('full-mode');
        
        // Show detail panel
        $('#detail-panel').addClass('active');
        
        // Handle list panel state based on mode
        if (isFullMode) {
            // In full mode, keep list hidden
            $('#list-panel').removeClass('split-mode').addClass('hidden');
        } else {
            // In split mode, show list
            $('#list-panel').addClass('split-mode').removeClass('hidden');
        }
        
        // Show navigation buttons
        updateNavButtons();

        // Populate detail content - escape HTML safely
        const severity = groupItems[0].severity.toLowerCase();
        const title = vulnerabilityInfo.title || groupName;
        
        const detailContent = `
                        <div class="vuln-details">
                <h4 style="color: #e0e0e0; margin-bottom: 20px;">
                    <span class="badge bg-${severity} me-2">${groupItems[0].severity}</span>
                    ${title}
                </h4>
                
                <div class="mb-4">
                    <h5 style="color: #e0e0e0;"><i class="fas fa-info-circle fa-fw text-primary"></i> ${vulnerabilityInfo.title}</h5>
                            <p class="text-white-50">${vulnerabilityInfo.what}</p>
                </div>
                            
                <div class="mb-4">
                    <h5 style="color: #e0e0e0;"><i class="fas fa-hammer fa-fw text-danger"></i> How It Works</h5>
                            <p class="text-white-50">${vulnerabilityInfo.how}</p>
                </div>

                <div class="mb-4">
                    <h5 style="color: #e0e0e0;"><i class="fas fa-shield-alt fa-fw text-success"></i> How to Prevent It</h5>
                            <div class="text-white-50">${vulnerabilityInfo.prevention}</div>
                        </div>

                <hr style="border-color: var(--border-color); opacity: 0.3; margin: 30px 0;">
                
                <h5 style="color: #e0e0e0; margin-bottom: 15px;"><i class="fas fa-map-marker-alt fa-fw"></i> Affected Locations (${groupItems.length})</h5>
                <div style="max-height: 400px; overflow-y: auto;">
                            ${groupItems.map(item => `
                        <div style="background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="flex-grow-1">
                                    <div class="mb-2">
                                        <strong style="color: #e0e0e0; display: block; margin-bottom: 5px;"><i class="fas fa-link fa-fw"></i> URL:</strong>
                                        <code style="font-size: 0.85rem; word-break: break-all;">${item.url}</code>
                                        </div>
                                    ${item.payload ? `
                                    <div class="mb-2">
                                        <strong style="color: #e0e0e0; display: block; margin-bottom: 5px;" title="The exact malicious input that triggers this vulnerability"><i class="fas fa-crosshairs fa-fw"></i> Payload Used:</strong>
                                        <div class="payload-display">
                                            <code style="font-size: 0.9rem; color: #ff6b6b; background: transparent;">${item.payload}</code>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.evidence ? `
                                    <div class="mb-2">
                                        <strong style="color: #e0e0e0; display: block; margin-bottom: 5px;" title="Evidence that confirmed this vulnerability"><i class="fas fa-microscope fa-fw"></i> Evidence:</strong>
                                        <code style="font-size: 0.85rem;">${item.evidence}</code>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="ms-3">
                                    ${item.cvss_base_score ? `<div class="mb-2"><span class="badge bg-danger" style="display: block; padding: 8px 12px; min-width: 80px;" title="CVSS Base Score: ${item.cvss_base_score.toFixed(1)} out of 10.0 (Higher = more severe)">CVSS ${item.cvss_base_score.toFixed(1)}</span></div>` : ''}
                                    ${item.final_priority ? `<div class="mb-2"><span class="badge bg-${item.final_priority === 'Critical' ? 'danger' : item.final_priority === 'High' ? 'warning' : item.final_priority === 'Medium' ? 'info' : 'secondary'}" style="display: block; padding: 8px 12px; min-width: 80px;" title="Priority: ${item.final_priority}. Combines CVSS score, asset criticality, exploit availability, and confidence">${item.final_priority}</span></div>` : ''}
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                ${item.occurrences > 1 ? `<div class="col-auto"><span class="badge bg-warning" title="Found by ${item.occurrences} different scanners - higher confidence"><i class="fas fa-layer-group fa-fw"></i> ${item.occurrences}x</span></div>` : ''}
                                ${item.asset_criticality ? `<div class="col-auto"><span class="badge bg-${item.asset_criticality >= 8 ? 'danger' : item.asset_criticality >= 6 ? 'warning' : 'secondary'}" title="Asset Criticality: ${item.asset_criticality}/10. How critical is this server/endpoint"><i class="fas fa-server fa-fw"></i> ${item.asset_criticality}/10</span></div>` : ''}
                                ${item.exploit_published ? `<div class="col-auto"><span class="badge bg-danger" title="Active exploit available in the wild"><i class="fas fa-bug fa-fw"></i> Exploit</span></div>` : ''}
                                ${typeof item.confidence === 'number' ? `<div class="col-auto"><span class="badge bg-info" title="Detection Confidence: ${(item.confidence * 100).toFixed(0)}% certain this is a real vulnerability"><i class="fas fa-check-circle fa-fw"></i> ${(item.confidence * 100).toFixed(0)}%</span></div>` : ''}
                                ${item.cwe ? `<div class="col-auto"><span class="badge bg-secondary" title="Common Weakness Enumeration: ${item.cwe}"><i class="fas fa-code fa-fw"></i> ${item.cwe}</span></div>` : ''}
                            </div>
                            ${(item.impact_score && item.exploitability_score) ? `
                            <div class="mt-2 p-3" style="background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 3px solid var(--primary-accent);">
                                <small class="text-white-50 d-block mb-2" style="font-weight: 600;"><i class="fas fa-chart-line fa-fw"></i> CVSS Breakdown:</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-success d-block" title="Impact Score: How much damage can be caused">Impact: <strong>${item.impact_score.toFixed(1)}</strong></small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-warning d-block" title="Exploitability Score: How easy it is to exploit">Exploitability: <strong>${item.exploitability_score.toFixed(1)}</strong></small>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            <p class="text-white-50 mt-3 mb-0" style="font-size: 0.9rem;">${item.description}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        $('#detail-content').html(detailContent);
    }
    
    function downloadReport(filename) {
        window.location.href = `/api/download/${filename}`;
    }
    
    function showError(message) {
        $('#error-message').html(message);
        $('#error-container').show();
        $('#progress-container').hide();
    }
    
    function resetUI() {
        $('#start-scan .spinner-border').hide();
        $('#start-scan .btn-text').html('<i class="fas fa-search fa-fw"></i> Start Scan');
        $('#start-scan').prop('disabled', false);
    }

    function updateNavButtons() {
        const prevBtn = $('#prev-vuln');
        const nextBtn = $('#next-vuln');
        const isFullMode = $('#detail-panel').hasClass('full-mode');
        
        // Show navigation buttons only in full mode
        if (isFullMode) {
            if (currentVulnIndex > 0) {
                prevBtn.show();
            } else {
                prevBtn.hide();
            }
            
            if (currentVulnIndex < allVulnGroups.length - 1) {
                nextBtn.show();
            } else {
                nextBtn.hide();
            }
        } else {
            // Hide buttons in split mode
            prevBtn.hide();
            nextBtn.hide();
        }
    }

    window.navigateVuln = function(direction) {
        const newIndex = currentVulnIndex + direction;
        if (newIndex >= 0 && newIndex < allVulnGroups.length) {
            const groupName = allVulnGroups[newIndex];
            const groupItems = window.groupedFindings[groupName];
            
            // Update active item in list
            $('.vuln-list-item').removeClass('active');
            $(`.vuln-list-item[data-index="${newIndex}"]`).addClass('active');
            
            // Show the detail for this vulnerability (preserves full mode state)
            showVulnerabilityDetail(groupName, newIndex, groupItems);
        }
    };

    window.toggleExpandMinimize = function() {
        const $detailPanel = $('#detail-panel');
        const $listPanel = $('#list-panel');
        const $btn = $('#expand-minimize-btn');
        const $icon = $btn.find('i');
        
        if ($detailPanel.hasClass('full-mode')) {
            // Minimize - return to split view
            $detailPanel.removeClass('full-mode');
            $listPanel.removeClass('hidden').addClass('split-mode');
            $icon.removeClass('fa-compress').addClass('fa-expand');
            $btn.attr('title', 'Expand');
        } else {
            // Expand - go to full view
            $detailPanel.addClass('full-mode');
            $listPanel.addClass('hidden').removeClass('split-mode');
            $icon.removeClass('fa-expand').addClass('fa-compress');
            $btn.attr('title', 'Minimize');
        }
        
        // Force a reflow to ensure CSS transition works
        $detailPanel[0].offsetHeight;
        
        updateNavButtons();
    };
});
</script>
{% endblock %}